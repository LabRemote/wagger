<!DOCTYPE html>
<html>

<head>

<link rel="apple-touch-icon" sizes="180x180" href="/client/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/client/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/client/icons/favicon-16x16.png">
<link rel="manifest" href="/client/site.webmanifest">
<link rel="mask-icon" href="/client/icons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Särskilda hinder för sjöfart - Test Site Bothnia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.boatmarker/leaflet.boatmarker.min.js"></script>
<script language="javascript" type="text/javascript" src="utils.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-beta.2.rc.2/leaflet.css">
<style id="compiled-css" type="text/css"> #map { height: 400px; } /* EOS */ </style>
</head>

<body>

<div id="map"></div>

<script type="text/javascript">

let A = new App();
let Ais = new AisData();

var CustomIcon = L.Icon.extend(
{
    options: 
    {
        //shadowUrl: 'leaf-shadow.png',
        iconSize:     [38, 55],
        //shadowSize:   [50, 64],
        iconAnchor:   [19, 27],
        //shadowAnchor: [4, 62],
        popupAnchor:  [-0, -27]
    }
});
var shore_icon = new CustomIcon({iconUrl: 'icons/building_symbol.png'}),
    sea_mobile_icon = new CustomIcon({iconUrl: 'icons/ship_symbol.png'}),
    land_mobile_icon = new CustomIcon({iconUrl: 'icons/land_vehicle_symbol.png'}),
    redIcon = new CustomIcon({iconUrl: 'icons/ais_aton_special_mark.png'}),
    orangeIcon = new CustomIcon({iconUrl: 'icons/ais_aton_special_mark_virtual.png'});

// center of the map
var center = [62.826, 17.879];
var shore = [62.8315, 17.8705];
var sea_mobile = [62.827, 17.90];
var land_mobile = [62.832, 17.88];
var buoy_1 = [62.8219465526254, 17.878395190126632];
var buoy_2 = [62.830045904677235, 17.88962710650322];
var virtual_1 = [62.82410637983922, 17.883320754338765];
var virtual_2 = [62.8271661350588, 17.887655981226686];

// Create the map
var map = L.map('map').setView(center, 13);
// Set up the OSM layer
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
L.control.scale().addTo(map);
// add a marker in the given location
var shore_marker = L.marker(shore, {icon: shore_icon}).addTo(map).bindPopup("Testledningscentral<br>Tel. 07X-XXXXXXX<br>Passning kanal 16", {closeOnClick: false, autoClose: false});
var sea_mobile_marker = L.boatMarker(sea_mobile, {icon: sea_mobile_icon, idleCircle: false}).addTo(map).bindPopup("Sjömobil testövervakning<br>Tel. 07X-XXXXXXX<br>Passning kanal 16", {closeOnClick: false, autoClose: false});
L.marker(land_mobile, {icon: land_mobile_icon}).addTo(map).bindPopup("Landmobil testövervakning<br>Tel. 07X-XXXXXXX<br>Passning kanal 16", {closeOnClick: false, autoClose: false});
var buoy_2_marker = L.marker(buoy_2, {icon: redIcon}).addTo(map).bindPopup("Håll avstånd!<br>Mätboj", {closeOnClick: false, autoClose: false});
var buoy_1_marker = L.boatMarker(buoy_1, {icon: sea_mobile_icon, idleCircle: true}).addTo(map).bindPopup("Mätboj - håll avstånd!", {closeOnClick: false, autoClose: false});
L.marker(virtual_1, {icon: orangeIcon}).addTo(map).bindPopup("Obehörig trafik förbjuden!<br>Avgränsning testområde", {closeOnClick: false, autoClose: false});
L.marker(virtual_2, {icon: orangeIcon}).addTo(map).bindPopup("Obehörig trafik förbjuden!<br>Avgränsning testområde", {closeOnClick: false, autoClose: false});

var myInterval = setInterval
(
  function() 
  {
    var random_one_sided = Math.random();
    var random_two_sided = (Math.random()*(1 - (-1)) + (-1));
    buoy_1_marker.getPopup().setContent("Håll avstånd!<br>Sjömobil mätstation<br>Vindhastighet: " + (random_two_sided * 2 + 5).toString().substring(0,5) + " kts");
    buoy_1_marker.getPopup().update();
    buoy_1_marker.setHeadingWind( 0, random_two_sided * 2 + 5, random_two_sided * 10 + 190 ) ;
    sea_mobile_marker.setLatLng([sea_mobile[0]+random_one_sided/5000, sea_mobile[1]+random_one_sided/5000]);
    sea_mobile_marker.setHeadingWind( random_two_sided * 10 + 130, random_one_sided * 5 + 5, random_one_sided * 10 + 190 ) ;
    //console.log(Ais.MMSI_ARRAY);
    //console.log(Ais.POS_ARRAY);
    Ais.MARKER_ARRAY = [];
    for (let _mmsi_counter = 0; _mmsi_counter < Ais.MMSI_ARRAY.length; _mmsi_counter++)
    {
      let latitude = Ais.POS_ARRAY[_mmsi_counter][1];
      let longitude = Ais.POS_ARRAY[_mmsi_counter][0];
      if (typeof latitude !== 'undefined' && typeof longitude !== 'undefined')
      {
        Ais.MARKER_ARRAY.push(L.boatMarker([ latitude, longitude ], {icon: sea_mobile_icon, idleCircle: true}).addTo(map).bindPopup("", {closeOnClick: false, autoClose: false}) );
      }
    }
    //console.log(Ais.MARKER_ARRAY);
  }, 5000
);


const api_url = 'http://labremote.net/client/get_uploaded.php?web_api_channel=148' ;

//let firstTime = true;

async function getISS() 
{
  const response = await fetch(api_url);
  const data = await response.json();
  let data_array = A.decodeTransferString(data)
  let ais_string_array = data_array[2][0];
  for (let _ais_string_counter = 0; _ais_string_counter < ais_string_array.length; _ais_string_counter++)
  {
    let ais_string = ais_string_array[_ais_string_counter]
    if (ais_string.length > 0)
    {
      const regex_comma = /\|/g;
      const regex_semicolon = /\~/g;
      let ais_json_string = ais_string.replace(regex_semicolon, ";").replace(regex_comma, ",");
      //console.log(ais_json_string);
      let ais_json = JSON.parse(ais_json_string)[0];
      let mmsi_index = Ais.MMSI_ARRAY.indexOf(ais_json["mmsi"]);
      if (mmsi_index === -1)
      {
        Ais.MMSI_ARRAY.push( ais_json["mmsi"] ) ;
        Ais.POS_ARRAY.push( [ ais_json["lon"], ais_json["lat"] ] ) ;
      }
      else
      {
        if (typeof ais_json["lon"] !== 'undefined' && typeof ais_json["lat"] !== 'undefined') Ais.POS_ARRAY[mmsi_index] = [ ais_json["lon"], ais_json["lat"] ] ;
      }
    }
  }

  //const { latitude, longitude } = data;
  //marker.setLatLng([latitude, longitude]);
  //if (firstTime) 
  //{
  //  mymap.setView([latitude, longitude], 2);
  //  firstTime = false;
  //}
  //document.getElementById('lat').textContent = latitude.toFixed(2);
  //document.getElementById('lon').textContent = longitude.toFixed(2);
}

getISS();

setInterval(getISS, 2000);


</script>

</body>

</html>
