"use strict";let App={CANVAS:{},CANVAS_POS_X:250,CANVAS_POS_Y:10,STD_SCALE_HEIGHT:480,WARNING_FONTSIZE:36,STANDARD_FONTSIZE:12,MAX_DISPLAY_DIGITS:10,STANDARD_FOREGROUND_COLOR:[255,255,255,255],STANDARD_BACKGROUND_COLOR:[0,0,255,255],FRAME_RATE:5,REQUEST_INTERVAL:2,NTP_SYNC_INTERVAL:60,TIME_ZONE:"UTC"};App.BROWSER_URL=window.location.hostname,App.CLIENT_URL="http://"+App.BROWSER_URL+"/client/",App.FILES_DIR="images/",App.FILES_URL=App.CLIENT_URL+App.FILES_DIR,App.WAIT_MESSAGE="Retrieving data...",App.last_get=5,App.last_request=0,App.last_time_sync=0,App.display_index=0,App.display_timeout=900,App.display_is_static=!1,App.chan_index_string="",App.img_chan_index_string="",App.ctrl_chan_index_string="",App.img_url="",App.img={},App.img_height=App.STD_SCALE_HEIGHT,App.img_width=4/3*App.img_height,App.start_time=-9999,App.end_time=-9999,App.time_bins=10,App.time_bin_size=1,App.data_time_string="",App.data_timestamp=0,App.server_time_string=App.WAIT_MESSAGE,App.server_timestamp=0,App.frames_active=0,App.ntp={},App.ntp.t1=0,App.ntp.t2=0,App.ntp.t3=0,App.ntp.t4=0,App.ntp.adjustment=0,App.ntp.timestamp=0,App.ntp.time_string=0,App.canvas_shift_x=0,App.canvas_shift_y=0,App.moved_slider=null,App.pressed_send=null,App.hovered_clicked_label=null;let Display={};function setup(){frameRate(App.FRAME_RATE),App.ntp.t1=parseInt(1e3*(new Date).valueOf()),httpGet(App.CLIENT_URL+"server_time.php","json",{},handle_server_time);let t={screen_layout_file:document.getElementById("screenLayoutFile").value};httpGet(App.CLIENT_URL+"get_screen_data.php","json",t,handle_display_data),App.img_url=App.FILES_URL+"0.png",App.img=loadImage(App.img_url),App.img_width=1280/(720/App.STD_SCALE_HEIGHT),App.img_height=720/(720/App.STD_SCALE_HEIGHT),App.CANVAS=createCanvas(1500,800),App.CANVAS.parent("myContainer"),App.CANVAS.position(App.CANVAS_POS_X,App.CANVAS_POS_Y)}function draw(){if(""===App.img_chan_index_string&&clear(),image(App.img,App.canvas_shift_x,App.canvas_shift_y,App.img_width,App.img_height),textSize(App.STANDARD_FONTSIZE),App.frames_active++,App.frames_active<App.display_timeout*App.FRAME_RATE){null!=App.DISPLAY_SELECT&&(App.DISPLAY_SELECT.style.visibility="visible"),fill(color(App.STANDARD_FOREGROUND_COLOR)),textSize(App.STANDARD_FONTSIZE),App.img=loadImage(App.img_url);let t=null;if(void 0!==Display.data[App.display_index]&&(t=Display.data[App.display_index].screens[0]),null!==t){let e="",i="";null!==App.hovered_clicked_label&&([e,i]=getTagChannelIndex(App.hovered_clicked_label));let p=t.time;if(null!==p){let t=getChannelElement(["timelabel",null]);t.innerHTML=p.str_val+p.padding,"timebkg"===e&&(t.innerHTML=p.str_val+p.info+(-App.ntp.adjustment/1e6).toString().substring(0,7)+" s")}for(let e=0;e<t.channels.length;e++){let p=t.channels[e],n=p.index.toString(),l=getChannelElement(["label",n]);l.innerHTML=p.str_val+p.padding,i===n&&(l.innerHTML=p.val.toString()+" "+p.unit+p.info)}for(let e=0;e<t.img_channels.length;e++);for(let e=0;e<t.ctrl_channels.length;e++){let p=t.ctrl_channels[e],n=p.index.toString(),l=getChannelElement(["setval",n]);if(l.innerHTML=p.str_val+p.padding,i===n){l.innerHTML=p.str_val+p.info,getChannelElement(["slider",n]).value=p.val}}}}if(fill(color(App.STANDARD_FOREGROUND_COLOR)),textSize(App.STANDARD_FONTSIZE),frameCount-App.last_time_sync>=App.NTP_SYNC_INTERVAL*App.FRAME_RATE&&App.frames_active<App.display_timeout*App.FRAME_RATE&&!1===App.display_is_static&&(App.ntp.t1=parseInt(1e3*(new Date).valueOf()),httpGet(App.CLIENT_URL+"server_time.php","json",{},handle_server_time),App.last_time_sync=frameCount),frameCount-App.last_request>=App.REQUEST_INTERVAL*App.FRAME_RATE&&App.frames_active<App.display_timeout*App.FRAME_RATE&&!1===App.display_is_static){if(""!==App.chan_index_string){let t={channels:App.chan_index_string,start_time:App.start_time,end_time:App.end_time,duration:App.time_bins,unit:App.time_bin_size,delete_horizon:3600};httpPost(App.CLIENT_URL+"send_request.php","json",t,handle_request_data)}if(""!==App.img_chan_index_string){let t={channels:App.img_chan_index_string,start_time:App.start_time,end_time:App.end_time,duration:App.time_bins,unit:App.time_bin_size,delete_horizon:3600};httpPost(App.CLIENT_URL+"send_request.php","json",t,handle_request_data)}App.last_request=frameCount}if(frameCount-App.last_get>=App.REQUEST_INTERVAL*App.FRAME_RATE&&App.frames_active<App.display_timeout*App.FRAME_RATE&&!1===App.display_is_static){if(""!==App.ctrl_chan_index_string){let t={channels:App.ctrl_chan_index_string,start_time:App.start_time,end_time:App.end_time,duration:-9999,unit:App.time_bin_size,lowest_status:1};httpPost(App.CLIENT_URL+"get_uploaded.php","json",t,handle_get_data)}if(""!==App.chan_index_string){let t={channels:App.chan_index_string,start_time:App.start_time,end_time:App.end_time,duration:App.time_bins,unit:App.time_bin_size,lowest_status:0};httpPost(App.CLIENT_URL+"get_uploaded.php","json",t,handle_get_data)}if(""!==App.img_chan_index_string){let t={channels:App.img_chan_index_string,start_time:App.start_time,end_time:App.end_time,duration:App.time_bins,unit:App.time_bin_size,lowest_status:0};httpPost(App.CLIENT_URL+"get_uploaded.php","json",t,handle_get_data)}App.last_get=frameCount}if(null!==App.pressed_send&&null!==App.moved_slider&&!1===App.display_is_static){let t={channels:App.moved_slider.id.split("_")[1]+";",start_time:App.start_time,end_time:App.end_time,value:App.moved_slider.value,duration:0,unit:1,delete_horizon:10};App.moved_slider=null,App.pressed_send=null,httpPost(App.CLIENT_URL+"send_request.php","json",t,handle_control_request_data)}if(App.ntp.timestamp=parseInt((new Date).valueOf()/1e3)+App.ntp.adjustment/1e6,App.frames_active>=App.display_timeout*App.FRAME_RATE)removeAllElements(App.CONTAINER),App.img=loadImage(App.FILES_URL+"000.jpg"),App.img_width=1280/(720/App.STD_SCALE_HEIGHT),App.img_height=720/(720/App.STD_SCALE_HEIGHT),text("Timeout due to inactivity - please reload page to continue data transfer!",220,250),reset_display_variables();else if(!1===App.display_is_static){let t=App.ntp.timestamp-App.data_timestamp;if(t>App.time_bins*App.time_bin_size||!navigator.onLine){if(App.frames_active%2==0?fill(255,0,0,127):fill(255,255,255,127),textSize(App.WARNING_FONTSIZE),!isValidNumber(t)||t>31536e4)text("",Math.max(App.img_width/2-7.8*App.WARNING_FONTSIZE,0),App.img_height/2+App.WARNING_FONTSIZE/2);else{let e=getTimeLagText(t),i="requesting new...";navigator.onLine||(i="no internet connection!"),text("Out of date ("+e+"), "+i,Math.max(App.img_width/2-7.8*App.WARNING_FONTSIZE,0),App.img_height/2+App.WARNING_FONTSIZE/2)}fill(App.STANDARD_FOREGROUND_COLOR),textSize(App.STANDARD_FONTSIZE)}}}function handle_server_time(t){App.ntp.t2=parseInt(t.receivetime/1),App.ntp.t3=parseInt(t.transmittime/1),App.ntp.t4=parseInt(1e3*(new Date).valueOf()),App.ntp.adjustment=parseInt((App.ntp.t2-App.ntp.t1+(App.ntp.t3-App.ntp.t4))/2)}function handle_control_request_data(t){}function handle_request_data(t){}function handle_image_request_data(t){}function handle_get_data(t){let e=t.returnstring.split(";"),i=(e.length-1)/2,p="",n="",l=n.split(","),s=[],a=[];for(let t=0;t<i;t++){p=e[2*t];let i=((l=(n=e[2*t+1]).split(",")).length-1)/4-0,r=[],_=[],A=[];for(let t=0;t<i;t++)r[t]=parseInt(l[4*t+0]),_[t]=parseFloat(l[4*t+1]),A[t]=l[4*t+3];s.push(r);let d=parseInt(p);a.push([d,_])}populate_display_variables(s,a)}function populate_display_variables(t,e){let i=App.ntp.timestamp;if(isValidGT(i,0)){App.server_timestamp=i;let p=new Date(1e3*i),n="";isValidDate(p)?(n=p.toISOString(),App.ntp.time_string=n.substring(0,10).concat(" ",n.substring(11,19)," ",App.TIME_ZONE),App.server_time_string=App.ntp.time_string):App.server_time_string=App.WAIT_MESSAGE;let l=Display.data[App.display_index].screens[0],s=l.time;null!==s&&(s.str_val=App.server_time_string,s.val=App.server_timestamp);let a=nthMaxOfArray(t[0],0);if(isValidGT(a,0)){App.data_timestamp=a;let t=new Date(1e3*a),i="";isValidDate(t)?(i=t.toISOString(),App.data_time_string=i.substring(0,10).concat(" ",i.substring(11,19)," ",App.TIME_ZONE)):App.data_time_string=App.WAIT_MESSAGE;for(let t=0;t<l.img_channels.length;t++){let e=l.img_channels[t],i=App.FILES_URL+e.index.toString()+"_"+a.toString()+"."+e.ext;App.img_url=i,App.img=loadImage(i);let p=e.dim.h/e.disp.h,n=e.dim.h/p,s=e.dim.w/p;image(App.img,e.disp.pos.x,e.disp.pos.y,s,n)}for(let t=0;t<l.channels.length;t++){let i=l.channels[t],p=findWithAttr(e,0,i.index);if(p>-1){let t=e[p][1],n=t[t.length-1];i.val=n*i.scale,isValidNumber(i.val)?i.str_val=i.val.toString().substring(0,i.disp.len)+" "+i.unit:i.str_val=App.WAIT_MESSAGE}}for(let t=0;t<l.ctrl_channels.length;t++){let i=l.ctrl_channels[t],p=findWithAttr(e,0,i.index);if(p>-1){let t=e[p][1],n=t[t.length-1];i.val=n*i.scale,isValidNumber(i.val)?i.str_val=i.val.toString().substring(0,i.disp.len)+" "+i.unit:i.str_val=App.WAIT_MESSAGE}}}}}function reset_display_variables(){App.server_time_string=App.WAIT_MESSAGE;let t=Display.data[App.display_index].screens[0];if(null!==t.time){App.display_is_static=!1;for(let e=0;e<t.channels.length;e++)t.channels[e].str_val=App.WAIT_MESSAGE}else App.display_is_static=!0}function mousePressed(){}function circle_button(t,e,i){dist(mouseX,mouseY,t,e);ellipseMode(CENTER),stroke(0,0),strokeWeight(i/4),stroke(0,0),ellipse(t,e,i,i)}function handle_display_data(t){Display.data=t.displays,App.display_timeout=t.disp_timeout,document.title="LabRemote",App.CONTAINER=document.getElementById("myContainer");let e=document.createElement("SELECT");App.DISPLAY_SELECT=e,e.id="screen_select",App.CONTAINER.appendChild(e);for(let t=0;t<Display.data.length;t++)App.DISPLAY_SELECT.options[App.DISPLAY_SELECT.options.length]=new Option(Display.data[t].title,t);App.DISPLAY_SELECT.addEventListener("change",display_select_listener),App.DISPLAY_SELECT.style.position="absolute",App.DISPLAY_SELECT.style.left="10px",App.DISPLAY_SELECT.style.top="10px",App.DISPLAY_SELECT.style.visibility="hidden",display_select_listener()}function label_listener(){App.hovered_clicked_label=this,this.style.visibility="visible";let[t,e]=getTagChannelIndex(this);if("timebkg"===t){let t=getChannelElement(["timelabel",null]);if(null!==t){t.style.visibility="visible";let e=Display.data[App.display_index].screens[0].time,i=e.str_val+e.info;t.innerHTML=i+(-App.ntp.adjustment/1e6).toString().substring(0,7)+" s"}}let i=getChannelElement(["setval",e]);if(null!==i){i.style.visibility="visible";let t=Display.data[App.display_index].screens[0].ctrl_channels,p=t[findWithAttr(t,"index",parseInt(e))],n="",l=(n=""!==p.str_val?p.str_val:(p.val*p.scale).toString().substring(0,p.disp.len)+" "+p.unit)+p.info;i.innerHTML=l;let s=getChannelElement(["slider",e]);null!==s&&(s.style.visibility="visible",s.value=p.val);let a=getChannelElement(["send",e]);null!==a&&(a.style.visibility="visible")}let p=getChannelElement(["label",e]);if(null!==p){p.style.visibility="visible";let t=Display.data[App.display_index].screens[0].channels,i=t[findWithAttr(t,"index",parseInt(e))],n="",l=(n=i.val.toString()+" "+i.unit)+i.info;p.innerHTML=l}}function outside_label_listener(){App.hovered_clicked_label=null,this.style.visibility="hidden";let[t,e]=getTagChannelIndex(this);if("timebkg"===t){let t=getChannelElement(["timelabel",null]);if(null!==t){let e=Display.data[App.display_index].screens[0].time.str_val;t.innerHTML=e+htmlSpaces(0)+"<br>"+htmlSpaces(10)}}let i=getChannelElement(["send",e]);null!==i&&(i.style.visibility="hidden");let p=getChannelElement(["slider",e]);null!==p&&(p.style.visibility="hidden");let n=getChannelElement(["setval",e]);if(null!==n){let t=Display.data[App.display_index].screens[0].ctrl_channels,i=t[findWithAttr(t,"index",parseInt(e))],p="";p=""!==i.str_val?i.str_val:(i.val*i.scale).toString().substring(0,i.disp.len)+" "+i.unit,n.innerHTML=p+htmlSpaces(0)+"<br>"+htmlSpaces(10)}let l=getChannelElement(["label",e]);if(null!==l){let t=Display.data[App.display_index].screens[0].channels,i=t[findWithAttr(t,"index",parseInt(e))],p="";p=""!==i.str_val?i.str_val:(i.val*i.scale).toString().substring(0,i.disp.len)+" "+i.unit,l.innerHTML=p+htmlSpaces(0)+"<br>"+htmlSpaces(10)}}function send_listener(){this.disabled=!0,this.style.opacity="0.5",App.pressed_send=this}function slider_listener(){let[t,e]=getTagChannelIndex(this),i=getChannelElement(["setval",e]),p=getChannelElement(["send",e]),n=parseInt(e),l=parseFloat(this.value);p.disabled=!1,p.style.opacity="1.0";let s=[],a=Display.data[App.display_index].screens[0].ctrl_channels;for(let t=0;t<a.length;t++)a[t].index===n&&(s=a[t]);let r="";""!==s.min_str_val&&""!==s.max_str_val&&""!==s.str_val?(r=s.min_str_val,l>.5&&(r=s.max_str_val)):r=(l*s.scale).toString().substring(0,s.disp.len)+" "+s.unit,s.str_val=r,s.val=l,r+=s.info,i.innerHTML=r,App.moved_slider=this}function display_select_listener(){background(255),App.frames_active=0,clear(),App.channel_strings_array=[],removeAllElements(App.CONTAINER),App.display_index=parseInt(App.DISPLAY_SELECT.options[App.DISPLAY_SELECT.selectedIndex].value);let t=Display.data[App.display_index].screens[0],e=t.imgs.length;if(e>0){for(let i=0;i<e;i++){let e=t.imgs[i];0===i&&(App.img_url=App.FILES_URL+e.file.toString());let p=e.dim.h/e.disp.h;App.img_height=e.dim.h/p,App.img_width=e.dim.w/p,App.canvas_shift_x=e.disp.pos.x,App.canvas_shift_y=e.disp.pos.y}App.img=loadImage(App.img_url)}else App.img_url=App.FILES_URL+"00.jpg",App.img=loadImage(App.img_url);let i=t.time;if(null!==i){App.time_bins=i.bins,App.time_bin_size=i.bin_size;let t=i.disp,e=t.col,p=t.bgcol,n=document.createElement("DIV");App.CONTAINER.appendChild(n);let l=document.createElement("BUTTON");n.appendChild(l),l.innerHTML="";let s=document.createTextNode("");l.appendChild(s),n.style.width=(13.9*t.size).toString()+"px",n.style.height=(4.1*t.size+4).toString()+"px",n.style.position="absolute",n.style.left=(t.pos.x+App.CANVAS_POS_X-t.size/2+1).toString()+"px",n.style.top=(t.pos.y+App.CANVAS_POS_Y-t.size+1).toString()+"px",n.style.visibility="hidden",n.title="",n.style.fontSize=t.size.toString()+"px",n.style.color="rgba("+e.r.toString()+","+e.g.toString()+","+e.b.toString()+","+(e.a/255).toString()+")",n.style.backgroundColor="rgba("+p.r.toString()+","+p.g.toString()+","+p.b.toString()+","+(p.a/255).toString()+")",l.style.position="absolute",l.style.left=(.33*t.size).toString()+"px",l.style.top=(.34*t.size).toString()+"px",l.style.visibility="visible",l.title="",l.style.fontSize=t.size.toString()+"px",l.style.color="rgba("+e.r.toString()+","+e.g.toString()+","+e.b.toString()+","+(e.a/255).toString()+")",l.style.backgroundColor="transparent",l.style.border="transparent",l.style.outline="none",l.style.textAlign="left",n.id="timebkg",l.id="timelabel",n.addEventListener("mouseover",label_listener),n.addEventListener("mouseleave",outside_label_listener),i.info=htmlSpaces(0)+"<br>Last server response (NTP)<br>Client time offset: ",i.padding=htmlSpaces(5)+"<br>"+htmlSpaces(10)}let p=t.channels.length;App.chan_index_string="";for(let e=0;e<p;e++){let i=t.channels[e],p=i.disp,n=p.bgcol,l=p.col,s=i.index.toString();App.chan_index_string+=s+";";let a=document.createElement("DIV");App.CONTAINER.appendChild(a);let r=document.createElement("BUTTON");a.appendChild(r),r.innerHTML="";let _=document.createTextNode("");r.appendChild(_),a.style.width=(13.9*p.size).toString()+"px",a.style.height=(4.1*p.size+4).toString()+"px",a.style.position="absolute",a.style.left=(p.pos.x+App.CANVAS_POS_X-p.size/2+1).toString()+"px",a.style.top=(p.pos.y+App.CANVAS_POS_Y-p.size+1).toString()+"px",a.style.visibility="hidden",a.title="",a.style.fontSize=p.size.toString()+"px",a.style.color="rgba("+l.r.toString()+","+l.g.toString()+","+l.b.toString()+","+(l.a/255).toString()+")",a.style.backgroundColor="rgba("+n.r.toString()+","+n.g.toString()+","+n.b.toString()+","+(n.a/255).toString()+")",r.style.position="absolute",r.style.left=(.33*p.size).toString()+"px",r.style.top=(.34*p.size).toString()+"px",r.style.visibility="visible",r.title="",r.style.fontSize=p.size.toString()+"px",r.style.color="rgba("+l.r.toString()+","+l.g.toString()+","+l.b.toString()+","+(l.a/255).toString()+")",r.style.backgroundColor="transparent",r.style.border="transparent",r.style.outline="none",r.style.textAlign="left",a.id="chanbkg_"+s,r.id="label_"+s,a.addEventListener("mouseover",label_listener),a.addEventListener("mouseleave",outside_label_listener),i.info=htmlSpaces(0)+"<br>"+i.label.toString()+"<br>Measurement channel "+s,i.padding=htmlSpaces(5)+"<br>"+htmlSpaces(10)}let n=t.img_channels.length;App.img_chan_index_string="";for(let e=0;e<n;e++){let i=t.img_channels[e],p=i.index.toString();App.img_chan_index_string+=p+";";let n=i.dim.h/i.disp.h;App.img_height=i.dim.h/n,App.img_width=i.dim.w/n,App.canvas_shift_x=i.disp.pos.x,App.canvas_shift_y=i.disp.pos.y}let l=t.ctrl_channels.length;App.ctrl_chan_index_string="";for(let e=0;e<l;e++){let i=t.ctrl_channels[e],p=i.disp,n=p.col,l=p.bgcol,s=i.index.toString();App.ctrl_chan_index_string+=s+";";let a=document.createElement("DIV");App.CONTAINER.appendChild(a);let r=document.createElement("INPUT"),_=document.createElement("BUTTON"),A=document.createElement("BUTTON");a.appendChild(r),a.appendChild(_),a.appendChild(A);let d=document.createTextNode("");_.appendChild(d),a.style.width=(10.8*p.size).toString()+"px",a.style.height=(8.2*p.size).toString()+"px",a.style.position="absolute",a.style.left=(p.pos.x+App.CANVAS_POS_X-p.size/2+7).toString()+"px",a.style.top=(p.pos.y+App.CANVAS_POS_Y-p.size+14).toString()+"px",a.style.visibility="hidden",a.title="",a.style.fontSize=p.size.toString()+"px",a.style.color="rgba("+n.r.toString()+","+n.g.toString()+","+n.b.toString()+","+(n.a/255).toString()+")",a.style.backgroundColor="rgba("+l.r.toString()+","+l.g.toString()+","+l.b.toString()+","+(l.a/255).toString()+")",r.style.width=(9*p.size).toString()+"px",r.style.height=(1.8*p.size).toString()+"px",r.style.position="absolute",r.style.left=(.7*p.size).toString()+"px",r.style.top=(.6*p.size).toString()+"px",r.style.visibility="hidden",r.title="",r.style.fontSize=p.size.toString()+"px",_.style.position="absolute",_.style.left=(.38*p.size).toString()+"px",_.style.top=(3*p.size).toString()+"px",_.style.visibility="visible",_.title="",_.style.fontSize=p.size.toString()+"px",_.style.color="rgba("+n.r.toString()+","+n.g.toString()+","+n.b.toString()+","+(n.a/255).toString()+")",_.style.backgroundColor="transparent",_.style.border="transparent",_.style.outline="none",_.style.textAlign="left",A.style.width=(2.7*p.size).toString()+"px",A.style.height=(1.6*p.size).toString()+"px",A.style.position="absolute",A.style.left=(7.3*p.size).toString()+"px",A.style.top=(3.1*p.size).toString()+"px",A.style.visibility="hidden",A.title="",A.style.fontSize=p.size.toString()+"px",A.disabled=!0,A.style.borderRadius="10%",A.style.opacity="0.5",A.style.textAlign="center",a.id="ctrlbkg_"+s,r.id="slider_"+s,_.id="setval_"+s,A.id="send_"+s,a.addEventListener("mouseover",label_listener),a.addEventListener("mouseleave",outside_label_listener),r.type="range",r.addEventListener("input",slider_listener),r.min=i.min_val,r.max=i.max_val,r.step=i.val_step,r.value=i.val;let o="";""!==i.min_str_val&&""!==i.max_str_val&&""!==i.str_val?(r.min=0,r.max=1,r.step=1,r.value=0,o=i.min_str_val):o=(i.val*i.scale).toString().substring(0,i.disp.len)+" "+i.unit,i.str_val=o,i.info=htmlSpaces(0)+"<br>"+htmlSpaces(10)+"<br>"+i.label.toString()+"<br>Control channel "+s,i.padding=htmlSpaces(0)+"<br>"+htmlSpaces(10)+"<br>"+htmlSpaces(10),_.innerHTML=o+i.padding,A.addEventListener("click",send_listener),A.innerHTML="Go"}reset_display_variables()}Display.data=[];